"use client"

import { useState, useEffect } from "react"
import { Users, Play, Square, AlertCircle, RefreshCw } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"
import GameMaking from "./game-making/page"
import AdminPage from "./admin/page"
import MyPage from "./mypage/page"
import type { User, Game, Court, Config } from "../types/database"
import {
  getUsers,
  getCourts,
  getConfig,
  getGamesByStatus,
  subscribeToGames,
  subscribeToUsers,
  createGame,
  updateGameStatus,
  autoStartWaitingGames,
  delayGame,
} from "../lib/supabase/queries"
import { autoLogin, logout } from "../lib/supabase/auth"
import LoginPage from "./auth/login/page"
import RegisterPage from "./auth/register/page"
import QueueCard from "../components/queue-card"
import QueueEditModal from "../components/queue-edit-modal"
import { supabase } from "../lib/supabase/client"

export default function HomePage() {
  const [currentPage, setCurrentPage] = useState<"home" | "game-making" | "admin" | "mypage">("home")
  const [loading, setLoading] = useState(true)
  const [refreshing, setRefreshing] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê
  const [currentUser, setCurrentUser] = useState<User | null>(null)
  const [config, setConfig] = useState<Config | null>(null)
  const [courts, setCourts] = useState<Court[]>([])
  const [users, setUsers] = useState<User[]>([])
  const [playingGames, setPlayingGames] = useState<Game[]>([])
  const [waitingGames, setWaitingGames] = useState<Game[]>([])
  const [timers, setTimers] = useState<{ [key: number]: number }>({})
  const [selectedCourt, setSelectedCourt] = useState<{ court: Court; game: Game | null } | null>(null)
  const [editingGame, setEditingGame] = useState<Game | null>(null)

  const [isAuthenticated, setIsAuthenticated] = useState(false)
  const [authPage, setAuthPage] = useState<"login" | "register">("login")
  const [migrationError, setMigrationError] = useState(false)
  const [sessionLoading, setSessionLoading] = useState(true)

  const getUserDisplayName = (user: User) => {
    if (!config) return user.name

    const skillMapping = {
      A: "Í≥†Ïàò",
      B: "Ï§ëÏàò",
      C: "Ï¥àÎ≥¥",
    }

    let displayName = user.name

    if (config.show_skill) {
      displayName = `${user.name}(${skillMapping[user.skill]})`
    }

    // Í≤åÏä§Ìä∏Ïù∏ Í≤ΩÏö∞ Ïù¥Î¶Ñ Îí§Ïóê ÏûëÏùÄ guest ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä
    if (user.is_guest) {
      displayName += " guest"
    }

    return displayName
  }

  const getUserTokenStyle = (user: User) => {
    if (!config) return "px-2 py-1 rounded text-sm bg-gray-100 text-gray-800"

    let baseStyle = "px-2 py-1 rounded text-sm "

    if (config.show_sex) {
      if (user.sex === "M") {
        baseStyle += "bg-blue-100 text-blue-800 "
      } else {
        baseStyle += "bg-pink-100 text-pink-800 "
      }
    } else {
      baseStyle += "bg-gray-100 text-gray-800 "
    }

    return baseStyle
  }

  // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÑ∏ÏÖò ÌôïÏù∏
  useEffect(() => {
    checkSession()
  }, [])

  // Ïù∏Ï¶ùÎêú ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    if (isAuthenticated && !migrationError) {
      loadInitialData()
    }
  }, [isAuthenticated, migrationError])

  // Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ
  useEffect(() => {
    if (!isAuthenticated || migrationError || !supabase) return

    let gamesSubscription: any
    let usersSubscription: any

    try {
      gamesSubscription = subscribeToGames(() => {
        console.log("üîÑ Games subscription triggered, reloading games...")
        loadGames()
      })

      usersSubscription = subscribeToUsers(() => {
        console.log("üîÑ Users subscription triggered, reloading users...")
        loadUsers()
      })

      console.log("‚úÖ Real-time subscriptions established")
    } catch (error) {
      console.error("‚ùå Subscription error:", error)
    }

    return () => {
      try {
        if (gamesSubscription) gamesSubscription.unsubscribe()
        if (usersSubscription) usersSubscription.unsubscribe()
        console.log("üîå Subscriptions unsubscribed")
      } catch (error) {
        console.error("‚ùå Unsubscribe error:", error)
      }
    }
  }, [isAuthenticated, migrationError])

  // ÌÉÄÏù¥Î®∏ ÏóÖÎç∞Ïù¥Ìä∏
  useEffect(() => {
    if (!isAuthenticated || migrationError) return

    const interval = setInterval(() => {
      const newTimers: { [key: number]: number } = {}
      playingGames.forEach((game) => {
        if (game.start_time && game.court_id) {
          newTimers[game.court_id] = Math.floor((Date.now() - new Date(game.start_time).getTime()) / 1000)
        }
      })
      setTimers(newTimers)
    }, 1000)

    return () => clearInterval(interval)
  }, [playingGames, isAuthenticated, migrationError])

  // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏûêÎèô Í≤åÏûÑ ÏãúÏûë Ï≤¥ÌÅ¨
  useEffect(() => {
    if (isAuthenticated && !migrationError && waitingGames.length > 0) {
      // ÌéòÏù¥ÏßÄ Î°úÎìú ÌõÑ 1Ï¥à Îí§Ïóê ÏûêÎèô ÏãúÏûë Ï≤¥ÌÅ¨
      const timer = setTimeout(() => {
        autoStartWaitingGames()
      }, 1000)

      return () => clearTimeout(timer)
    }
  }, [isAuthenticated, migrationError, waitingGames.length])

  // ÏÑ∏ÏÖò ÌôïÏù∏
  const checkSession = async () => {
    try {
      setSessionLoading(true)
      console.log("üîÑ Checking existing session...")

      // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä ÏóÜÏúºÎ©¥ ÌôòÍ≤Ω Î≥ÄÏàò Ïò§Î•ò
      if (!supabase) {
        setMigrationError(true)
        setIsAuthenticated(false)
        return
      }

      const user = await autoLogin()
      if (user) {
        console.log("‚úÖ Auto login successful:", user.username)
        setCurrentUser(user)
        setIsAuthenticated(true)
        setMigrationError(false)
      } else {
        console.log("‚ùå No valid session found")
        setIsAuthenticated(false)
      }
    } catch (err) {
      console.error("‚ùå Session check error:", err)
      const errorMessage = err instanceof Error ? err.message : "ÏÑ∏ÏÖò ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."

      if (errorMessage.includes("ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò") || errorMessage.includes("environment")) {
        setMigrationError(true)
      }

      setIsAuthenticated(false)
    } finally {
      setSessionLoading(false)
    }
  }

  const loadInitialData = async () => {
    try {
      setLoading(true)
      setError(null)

      // Load data sequentially to avoid overwhelming the database
      await loadUsers()
      await loadCourts()
      await loadConfig()
      await loadGames()
    } catch (err) {
      console.error("Initial data load error:", err)
      const errorMessage = err instanceof Error ? err.message : "Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."

      if (errorMessage.includes("ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò") || errorMessage.includes("environment")) {
        setMigrationError(true)
      }

      setError(errorMessage)
    } finally {
      setLoading(false)
    }
  }

  const loadUsers = async () => {
    try {
      const usersData = await getUsers()
      setUsers(usersData)
    } catch (err) {
      console.error("ÏÇ¨Ïö©Ïûê Î°úÎìú Ïò§Î•ò:", err)
      throw err
    }
  }

  const loadCourts = async () => {
    try {
      const courtsData = await getCourts()
      setCourts(courtsData)
    } catch (err) {
      console.error("ÏΩîÌä∏ Î°úÎìú Ïò§Î•ò:", err)
      throw err
    }
  }

  const loadConfig = async () => {
    try {
      const configData = await getConfig()
      setConfig(configData)
    } catch (err) {
      console.error("ÏÑ§Ï†ï Î°úÎìú Ïò§Î•ò:", err)
      throw err
    }
  }

  const loadGames = async () => {
    try {
      console.log("üîÑ Loading games...")
      const [playingData, waitingData] = await Promise.all([getGamesByStatus("playing"), getGamesByStatus("waiting")])

      console.log("‚úÖ Loaded playing games:", playingData)
      console.log("‚úÖ Loaded waiting games:", waitingData)

      setPlayingGames(playingData)
      setWaitingGames(waitingData)
    } catch (err) {
      console.error("‚ùå Í≤åÏûÑ Î°úÎìú Ïò§Î•ò:", err)
      // Don't throw here, just log the error
    }
  }

  // ÏàòÎèô ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
  const handleManualRefresh = async () => {
    try {
      setRefreshing(true)
      console.log("üîÑ Manual refresh triggered")

      // Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÉàÎ°ú Î°úÎìú
      await Promise.all([loadUsers(), loadCourts(), loadConfig(), loadGames()])

      console.log("‚úÖ Manual refresh completed")
    } catch (err) {
      console.error("‚ùå Manual refresh error:", err)
      alert("ÏÉàÎ°úÍ≥†Ïπ® Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
    } finally {
      setRefreshing(false)
    }
  }

  const formatTime = (seconds: number) => {
    const minutes = Math.floor(seconds / 60)
    const remainingSeconds = seconds % 60
    return `${minutes.toString().padStart(2, "0")}:${remainingSeconds.toString().padStart(2, "0")}`
  }

  const handleGameToQueue = async (gameId: number) => {
    try {
      console.log(`üîÑ Moving game ${gameId} back to queue`)
      await updateGameStatus(gameId, "waiting")
      // Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖÏúºÎ°ú ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏Îê®
    } catch (err) {
      console.error("‚ùå Í≤åÏûÑ ÎåÄÍ∏∞Ïó¥ Ïù¥Îèô Ïò§Î•ò:", err)
      alert("Í≤åÏûÑÏùÑ ÎåÄÍ∏∞Ïó¥Î°ú Ïù¥ÎèôÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
    }
  }

  const handleLogin = (user: User) => {
    setCurrentUser(user)
    setIsAuthenticated(true)
    setMigrationError(false)
    // Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞Îäî useEffectÏóêÏÑú ÏûêÎèôÏúºÎ°ú Î°úÎìúÎê®
  }

  const handleLogout = () => {
    logout() // ÏÑ∏ÏÖò Ï†ïÎ¶¨
    setCurrentUser(null)
    setIsAuthenticated(false)
    setCurrentPage("home")
  }

  const handleRegisterSuccess = () => {
    setAuthPage("login")
    alert("ÌöåÏõêÍ∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Í¥ÄÎ¶¨Ïûê ÏäπÏù∏ ÌõÑ Î°úÍ∑∏Ïù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.")
  }

  const addToQueue = async (selectedUsers: User[], team1?: User[], team2?: User[]) => {
    try {
      console.log("üéÆ Adding to queue:", selectedUsers)
      const result = await createGame({
        status: "waiting",
        userIds: selectedUsers.map((user) => user.id),
      })

      if (result.autoStarted) {
        console.log("üöÄ Game auto-started on available court!")
      }

      setCurrentPage("home")
      // Í≤åÏûÑ Î™©Î°ùÏùÑ Ï¶âÏãú ÏÉàÎ°úÍ≥†Ïπ®
      setTimeout(() => {
        loadGames()
        loadUsers() // ÏÇ¨Ïö©Ïûê ÏÉÅÌÉúÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
      }, 500)
    } catch (err) {
      console.error("‚ùå Í≤åÏûÑ ÏÉùÏÑ± Ïò§Î•ò:", err)
      alert("Í≤åÏûÑ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
    }
  }

  const handleGameFinish = async (gameId: number, courtId: number) => {
    try {
      console.log(`üèÅ Finishing game ${gameId} on court ${courtId}`)
      await updateGameStatus(gameId, "finished", courtId)

      // Í∞ïÏ†úÎ°ú Ï¶âÏãú ÏÉàÎ°úÍ≥†Ïπ®
      loadGames()
      loadUsers()

      // Ï∂îÍ∞ÄÎ°ú 1Ï¥à ÌõÑÏóê Ìïú Î≤à Îçî ÏÉàÎ°úÍ≥†Ïπ®
      setTimeout(() => {
        loadGames()
        loadUsers()
      }, 1000)

      // 2Ï¥à ÌõÑÏóê Ìïú Î≤à Îçî ÏÉàÎ°úÍ≥†Ïπ® (ÌôïÏã§ÌïòÍ≤å)
      setTimeout(() => {
        loadGames()
        loadUsers()
      }, 2000)
    } catch (err) {
      console.error("‚ùå Í≤åÏûÑ Ï¢ÖÎ£å Ïò§Î•ò:", err)
      alert("Í≤åÏûÑ Ï¢ÖÎ£å Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
    }
  }

  const handleMenuClick = () => {
    setCurrentPage("mypage")
  }

  // Í≤åÏûÑ ÏßúÍ∏∞ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô Ïãú Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
  const handleGoToGameMaking = async () => {
    try {
      console.log("üîÑ Refreshing data before going to game making...")

      // ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Î°úÎìú
      await Promise.all([loadUsers(), loadGames()])

      setCurrentPage("game-making")
    } catch (err) {
      console.error("‚ùå Í≤åÏûÑ ÏßúÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:", err)
      // Ïò§Î•òÍ∞Ä ÏûàÏñ¥ÎèÑ ÌéòÏù¥ÏßÄÎäî Ïù¥Îèô
      setCurrentPage("game-making")
    }
  }

  const handleEditGame = (game: Game) => {
    setEditingGame(game)
  }

  const handleDeleteGame = async (game: Game) => {
    if (confirm("Ï†ïÎßêÎ°ú Ïù¥ Í≤åÏûÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
      try {
        // Í≤åÏûÑ ÏÇ≠Ï†ú Î°úÏßÅ (user_game_relationsÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê®)
        if (!supabase) throw new Error("Supabase client not available")

        const { error } = await supabase.from("games").delete().eq("id", game.id)
        if (error) throw error

        // Í≤åÏûÑ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        loadGames()
        loadUsers() // ÏÇ¨Ïö©Ïûê ÏÉÅÌÉúÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
      } catch (err) {
        console.error("Í≤åÏûÑ ÏÇ≠Ï†ú Ïò§Î•ò:", err)
        alert("Í≤åÏûÑ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
      }
    }
  }

  const handleDelayGame = async (game: Game) => {
    try {
      console.log(`üïê Delaying game ${game.id}`)
      await delayGame(game.id)

      // Ï¶âÏãú ÏÉàÎ°úÍ≥†Ïπ®Í≥º ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Ìïú Î≤à Îçî ÏÉàÎ°úÍ≥†Ïπ®
      loadGames()
      setTimeout(() => {
        loadGames()
      }, 1000)
    } catch (err) {
      console.error("Í≤åÏûÑ ÎØ∏Î£®Í∏∞ Ïò§Î•ò:", err)
      alert("Í≤åÏûÑ ÎØ∏Î£®Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
    }
  }

  const handleSaveEditedGame = async (gameId: number, newUserIds: number[]) => {
    try {
      if (!supabase) throw new Error("Supabase client not available")

      // Í∏∞Ï°¥ Í¥ÄÍ≥Ñ ÏÇ≠Ï†ú
      await supabase.from("user_game_relations").delete().eq("game_id", gameId)

      // ÏÉàÎ°úÏö¥ Í¥ÄÍ≥Ñ ÏÉùÏÑ±
      const relations = newUserIds.map((userId) => ({
        user_id: userId,
        game_id: gameId,
      }))

      const { error } = await supabase.from("user_game_relations").insert(relations)
      if (error) throw error

      setEditingGame(null)
      loadGames()
      loadUsers() // ÏÇ¨Ïö©Ïûê ÏÉÅÌÉúÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
    } catch (err) {
      console.error("Í≤åÏûÑ ÏàòÏ†ï Ïò§Î•ò:", err)
      alert("Í≤åÏûÑ ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
    }
  }

  // ÏÑ∏ÏÖò Î°úÎî© Ï§ë
  if (sessionLoading) {
    return (
      <div className="h-screen flex items-center justify-center bg-gray-50 max-w-md mx-auto">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
          <p className="text-gray-600">ÏÑ∏ÏÖò ÌôïÏù∏ Ï§ë...</p>
        </div>
      </div>
    )
  }

  // Show migration error screen
  if (migrationError) {
    return (
      <div className="h-screen flex items-center justify-center bg-gray-50 max-w-md mx-auto p-4">
        <Card className="w-full p-6">
          <div className="text-center">
            <AlertCircle className="h-12 w-12 text-yellow-600 mx-auto mb-4" />
            <h2 className="text-xl font-bold text-gray-900 mb-2">ÌôòÍ≤Ω ÏÑ§Ï†ï ÌïÑÏöî</h2>
            <p className="text-gray-600 mb-4">ÌôòÍ≤Ω Î≥ÄÏàòÎ•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî:</p>
            <div className="bg-gray-50 p-4 rounded-lg text-left mb-4">
              <div className="space-y-1 text-sm font-mono">
                <div>NEXT_PUBLIC_SUPABASE_URL</div>
                <div>NEXT_PUBLIC_SUPABASE_ANON_KEY</div>
                <div>SUPABASE_SERVICE_ROLE_KEY</div>
              </div>
            </div>
            <Button onClick={() => window.location.reload()} className="w-full">
              ÏÉàÎ°úÍ≥†Ïπ®
            </Button>
          </div>
        </Card>
      </div>
    )
  }

  // Authentication pages
  if (!isAuthenticated) {
    if (authPage === "register") {
      return <RegisterPage onBack={() => setAuthPage("login")} onRegisterSuccess={handleRegisterSuccess} />
    }
    return <LoginPage onLogin={handleLogin} onGoToRegister={() => setAuthPage("register")} />
  }

  if (loading) {
    return (
      <div className="h-screen flex items-center justify-center bg-gray-50 max-w-md mx-auto">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
          <p className="text-gray-600">Î°úÎî© Ï§ë...</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="h-screen flex items-center justify-center bg-gray-50 max-w-md mx-auto">
        <div className="text-center p-4">
          <p className="text-red-600 mb-4">{error}</p>
          <Button onClick={loadInitialData}>Îã§Ïãú ÏãúÎèÑ</Button>
        </div>
      </div>
    )
  }

  if (!currentUser || !config) {
    return (
      <div className="h-screen flex items-center justify-center bg-gray-50 max-w-md mx-auto">
        <p className="text-gray-600">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
      </div>
    )
  }

  if (currentPage === "mypage") {
    return (
      <MyPage
        onBack={() => setCurrentPage("home")}
        onGoToAdmin={() => setCurrentPage("admin")}
        onLogout={handleLogout}
        currentUser={currentUser}
        onUpdateUser={(user) => {
          setCurrentUser(user)
          loadUsers() // ÏÇ¨Ïö©Ïûê Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        }}
      />
    )
  }

  if (currentPage === "game-making") {
    return (
      <GameMaking
        onBack={() => setCurrentPage("home")}
        onAddToQueue={addToQueue}
        users={users}
        config={config}
        playingGames={playingGames}
        waitingGames={waitingGames}
        getUserDisplayName={getUserDisplayName}
        getUserTokenStyle={getUserTokenStyle}
      />
    )
  }

  if (currentPage === "admin") {
    return (
      <AdminPage
        onBack={() => setCurrentPage("home")}
        config={config}
        courts={courts}
        playingGames={playingGames}
        waitingGames={waitingGames}
        onConfigUpdate={setConfig}
        onCourtsUpdate={setCourts}
      />
    )
  }

  return (
    <div className="h-screen flex flex-col bg-gray-50 max-w-md mx-auto">
      {/* Navigation Bar */}
      <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center justify-between">
        <h1 className="text-xl font-bold text-gray-900">Ïä§Îß§ÏãúÌÅê</h1>
        <div className="flex items-center gap-2">
          {/* ÏàòÎèô ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº */}
          <Button variant="ghost" size="icon" onClick={handleManualRefresh} disabled={refreshing} className="h-8 w-8">
            <RefreshCw className={`h-4 w-4 ${refreshing ? "animate-spin" : ""}`} />
          </Button>

          <div className="flex items-center gap-1 text-xs text-gray-500">
            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            Ïã§ÏãúÍ∞Ñ
          </div>
          <div className="text-xs text-gray-700 font-medium">{currentUser?.name} Îãò</div>
          <Button variant="ghost" size="icon" onClick={handleMenuClick}>
            <span className="text-lg">‚ò∞</span>
          </Button>
        </div>
      </div>

      {/* Court Status */}
      <div className="bg-white px-4 py-4 border-b">
        <div className="flex gap-3 justify-center">
          {courts
            .filter((court) => court.is_active)
            .map((court) => {
              const game = playingGames.find((g) => g.court_id === court.id)
              return (
                <div key={court.id} className="flex flex-col items-center">
                  <div
                    className={`w-16 h-16 rounded-lg flex flex-col items-center justify-center text-xs font-medium cursor-pointer transition-all hover:scale-105 ${
                      game
                        ? "bg-green-100 border-2 border-green-300 text-green-800 hover:bg-green-200"
                        : "bg-gray-100 border-2 border-gray-300 text-gray-500 hover:bg-gray-200"
                    }`}
                    onClick={() => setSelectedCourt({ court, game })}
                  >
                    <div className="text-xs mb-1">ÏΩîÌä∏ {court.id}</div>
                    {game && timers[court.id] !== undefined && (
                      <div className="text-xs font-bold">{formatTime(timers[court.id])}</div>
                    )}
                  </div>
                </div>
              )
            })}
        </div>
      </div>

      {/* Queue Section */}
      <div className="flex-1 px-4 py-4 overflow-hidden">
        <div className="mb-4">
          <h2 className="text-lg font-semibold text-gray-900 mb-3">
            ÎåÄÍ∏∞Ïó¥ {waitingGames.length > 0 && `(${waitingGames.length}Í∞ú)`}
          </h2>
          <div className="space-y-2">
            {waitingGames.slice(0, 3).map((game, index) => (
              <QueueCard
                key={game.id}
                game={game}
                index={index}
                config={config}
                currentUser={currentUser}
                getUserDisplayName={getUserDisplayName}
                getUserTokenStyle={getUserTokenStyle}
                onEdit={handleEditGame}
                onDelete={handleDeleteGame}
                onDelay={handleDelayGame}
              />
            ))}
          </div>

          {waitingGames.length > 3 && (
            <Button variant="outline" className="w-full mt-3 bg-transparent" size="sm">
              <Users className="h-4 w-4 mr-2" />
              ÎåÄÍ∏∞Ïó¥ Î™®ÎëêÎ≥¥Í∏∞ ({waitingGames.length}Í∞ú)
            </Button>
          )}

          {waitingGames.length === 0 && (
            <div className="text-center py-6 text-gray-500">
              <Users className="h-10 w-10 mx-auto mb-2 opacity-30" />
              <p>ÎåÄÍ∏∞ Ï§ëÏù∏ Í≤åÏûÑÏù¥ ÏóÜÏäµÎãàÎã§</p>
              <p className="text-xs mt-1">Îπà ÏΩîÌä∏Í∞Ä ÏûàÏúºÎ©¥ Î∞îÎ°ú Í≤åÏûÑÏù¥ ÏãúÏûëÎê©ÎãàÎã§!</p>
            </div>
          )}
        </div>
      </div>

      {/* Bottom Button */}
      <div className="p-4 bg-white border-t">
        <Button
          className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 text-lg font-medium"
          onClick={handleGoToGameMaking}
        >
          <Play className="h-5 w-5 mr-2" />
          Í≤åÏûÑ ÏßúÍ∏∞
        </Button>
      </div>

      {/* Court Detail Modal */}
      {selectedCourt && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 w-full max-w-sm">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold">ÏΩîÌä∏ {selectedCourt.court.id}</h3>
              <Button variant="ghost" size="icon" onClick={() => setSelectedCourt(null)}>
                ‚úï
              </Button>
            </div>

            {selectedCourt.game ? (
              <div className="space-y-3">
                <div className="text-center">
                  <div className="text-2xl font-bold text-green-600 mb-2">
                    {timers[selectedCourt.court.id] !== undefined && formatTime(timers[selectedCourt.court.id])}
                  </div>
                  <div className="text-sm text-gray-600">Í≤åÏûÑ ÏßÑÌñâ Ï§ë</div>
                </div>

                <div>
                  <h4 className="font-medium mb-2">ÌîåÎ†àÏù¥Ïñ¥</h4>
                  {config?.enable_vs ? (
                    <div className="space-y-2">
                      <div>
                        <div className="text-xs text-gray-600 mb-1">Ï¢åÏ∏°</div>
                        <div className="flex flex-wrap gap-1">
                          {selectedCourt.game.users.slice(0, 2).map((user) => (
                            <div key={user.id} className={getUserTokenStyle(user) + " text-xs px-2 py-0.5"}>
                              {getUserDisplayName(user)}
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="text-center text-xs text-gray-500">VS</div>
                      <div>
                        <div className="text-xs text-gray-600 mb-1">Ïö∞Ï∏°</div>
                        <div className="flex flex-wrap gap-1">
                          {selectedCourt.game.users.slice(2, 4).map((user) => (
                            <div key={user.id} className={getUserTokenStyle(user) + " text-xs px-2 py-0.5"}>
                              {getUserDisplayName(user)}
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="flex flex-wrap gap-1">
                      {selectedCourt.game.users.map((user) => (
                        <div key={user.id} className={getUserTokenStyle(user) + " text-xs px-2 py-0.5"}>
                          {getUserDisplayName(user)}
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="space-y-2">
                  <div className="text-xs text-gray-600">
                    ÏãúÏûë ÏãúÍ∞Ñ: {new Date(selectedCourt.game.start_time!).toLocaleTimeString("ko-KR")}
                  </div>
                </div>

                <Button
                  className="w-full bg-red-600 hover:bg-red-700 text-white"
                  onClick={() => {
                    handleGameFinish(selectedCourt.game!.id, selectedCourt.court.id)
                    setSelectedCourt(null)
                  }}
                >
                  <Square className="h-4 w-4 mr-2" />
                  Í≤åÏûÑ Ï¢ÖÎ£å
                </Button>

                {currentUser?.admin_authority && (
                  <Button
                    variant="outline"
                    className="w-full bg-transparent"
                    onClick={() => {
                      handleGameToQueue(selectedCourt.game!.id)
                      setSelectedCourt(null)
                    }}
                  >
                    ÎåÄÍ∏∞Ïó¥Î°ú ÎèåÎ¶¨Í∏∞
                  </Button>
                )}
              </div>
            ) : (
              <div className="text-center py-8">
                <div className="text-gray-400 mb-4">
                  <div className="w-12 h-12 bg-gray-100 rounded-lg mx-auto mb-2 flex items-center justify-center">
                    <span className="text-2xl">üè∏</span>
                  </div>
                </div>
                <p className="text-gray-600 mb-4">ÎπÑÏñ¥ÏûàÎäî ÏΩîÌä∏ÏûÖÎãàÎã§</p>
                <div className="text-xs text-gray-500">ÎåÄÍ∏∞Ïó¥Ïóê Í≤åÏûÑÏù¥ ÏûàÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú ÏãúÏûëÎê©ÎãàÎã§</div>
              </div>
            )}
          </div>
        </div>
      )}
      {/* Queue Edit Modal */}
      {editingGame && (
        <QueueEditModal
          game={editingGame}
          users={users}
          config={config}
          onClose={() => setEditingGame(null)}
          onSave={handleSaveEditedGame}
          getUserDisplayName={getUserDisplayName}
          getUserTokenStyle={getUserTokenStyle}
        />
      )}
    </div>
  )
}

// Ïù¥ ÌéòÏù¥ÏßÄÎäî ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅÎêòÏñ¥Ïïº Ìï® (ÌôòÍ≤Ω Î≥ÄÏàò ÌïÑÏöî)
export const dynamic = "force-dynamic"
